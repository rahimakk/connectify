<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Connectify Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">

<div style="display: flex; justify-content: space-between; align-items: center;">
    <h1>Dashboard</h1>
    <button id="logout" class="btn btn-secondary">Logout</button>
</div>

<div style="display: flex; justify-content: space-evenly ;align-items: center;">
    <input type="number" id="searchId" placeholder="Enter user ID">
    <input type="text" id="searchName" placeholder="Enter user name">
    <button onclick="searchUser()">Search</button>
    <button onclick="fetchUsers()">Show All</button>
   
</div>
<div>
    <br>
</div>
<table class="table table-bordered" id="usersTable">
    <thead>
        <tr>
            <th>ID</th>
            <th>Full Name</th>
            <th>Email</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- Update User Modal -->
<div class="modal fade" id="updateUserModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Update User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input id="updateFullName" class="form-control mb-2" placeholder="Full Name">
        <input id="updateEmail" class="form-control mb-2" placeholder="Email">
        <input id="updatePassword" type="password" class="form-control mb-2" placeholder="Password (leave empty if not changing)">
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" id="submitUpdate">Submit</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const token = localStorage.getItem("token");
if (!token) window.location.href = "index.html";

document.getElementById("logout").onclick = () => {
    localStorage.removeItem("token");
    window.location.href = "index.html";
}

let selectedUserId = null;
const updateModal = new bootstrap.Modal(document.getElementById("updateUserModal"));

async function fetchUsers() {
    const res = await fetch("http://127.0.0.1:8001/users", {
        headers: { "Authorization": `Bearer ${token}` }
    });
    const users = await res.json();
    populateTable(users);
}

function populateTable(users) {
    const tbody = document.querySelector("#usersTable tbody");
    tbody.innerHTML = "";
    users.forEach(user => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${user.id}</td>
            <td>${user.full_name}</td>
            <td>${user.email}</td>
            <td>
                <button class="btn btn-sm btn-warning" onclick="openUpdateModal(${user.id}, '${user.full_name}', '${user.email}')">Update</button>
                <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">Delete</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// Open modal with user data
function openUpdateModal(id, full_name, email) {
    selectedUserId = id;
    document.getElementById("updateFullName").value = full_name;
    document.getElementById("updateEmail").value = email;
    document.getElementById("updatePassword").value = "";
    updateModal.show();
}

// Submit update
document.getElementById("submitUpdate").onclick = async () => {
    const updatedData = {
        full_name: document.getElementById("updateFullName").value,
        email: document.getElementById("updateEmail").value,
        password: document.getElementById("updatePassword").value
    };

    const res = await fetch(`http://127.0.0.1:8001/users/${selectedUserId}`, {
        method: "PATCH",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify(updatedData)
    });

    if (res.ok) {
        alert("User updated successfully!");
        fetchUsers();
        updateModal.hide();
    } else {
        alert("Update failed!");
    }
}
async function searchUser() {
    const id = document.getElementById("searchId").value;
    const name = document.getElementById("searchName").value;

    let url = "http://127.0.0.1:8001/users";
    if (id) {
        url += `/${id}`; // search by ID
    }

    const res = await fetch(url, {
        headers: { "Authorization": `Bearer ${token}` }
    });

    if (!res.ok) {
        if (res.status === 404) {
            alert("User not found!");
            document.querySelector("#usersTable tbody").innerHTML = "";
        } else {
            alert("Error fetching user");
        }
        return;
    }
let users = await res.json();

// If the response is a single object (search by ID), wrap it in an array
if (!Array.isArray(users)) {
    users = [users];
}

// If searching by name, filter results
if (name) {
    users = users.filter(user =>
        user.full_name.toLowerCase().includes(name.toLowerCase())
    );
}

if (users.length === 0) {
    alert("User not found!");
    document.querySelector("#usersTable tbody").innerHTML = "";
} else {
    populateTable(users);
}

}


// Delete user
async function deleteUser(id) {
    if (!confirm("Are you sure you want to delete this user?")) return;
    const res = await fetch(`http://127.0.0.1:8001/users/${id}`, {
        method: "DELETE",
        headers: { "Authorization": `Bearer ${token}` }
    });
    if (res.ok) {
        alert("User deleted successfully!");
        fetchUsers();
    } else {
        alert("Delete failed!");
    }
}

fetchUsers();
</script>
</body>
</html>
